apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: shared-workspace-storage
  namespace: workshop-system
  labels:
    app: workshop-template-system
    component: shared-workspace
    storage-type: rwx-workspace
  annotations:
    description: "Shared workspace storage for agents and Tekton pipelines (ADR-0007)"
    storage.kubernetes.io/provisioner: "ocs-storagecluster-cephfs"
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 10Gi
  storageClassName: ocs-storagecluster-cephfs

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: workspace-config
  namespace: workshop-system
  labels:
    app: workshop-template-system
    component: workspace-management
data:
  workspace-path: "/workspace/shared-data"
  workspace-structure: |
    # Enhanced Shared Workspace Structure (ADR-0007)
    /workspace/shared-data/
    â”œâ”€â”€ pipelines/                 # Pipeline-specific workspaces (isolated)
    â”‚   â”œâ”€â”€ {pipeline-run-id}/     # Unique per pipeline run
    â”‚   â”‚   â”œâ”€â”€ workspace-content/ # Git cloned repository content
    â”‚   â”‚   â”œâ”€â”€ agent-artifacts/   # Agent-generated content
    â”‚   â”‚   â”‚   â”œâ”€â”€ content-creator/
    â”‚   â”‚   â”‚   â”œâ”€â”€ source-manager/
    â”‚   â”‚   â”‚   â””â”€â”€ template-converter/
    â”‚   â”‚   â”œâ”€â”€ metadata/          # Pipeline metadata and coordination
    â”‚   â”‚   â”‚   â”œâ”€â”€ pipeline-info.json
    â”‚   â”‚   â”‚   â”œâ”€â”€ agent-status.json
    â”‚   â”‚   â”‚   â””â”€â”€ locks/         # File locking for coordination
    â”‚   â”‚   â””â”€â”€ final-output/      # Ready for Gitea deployment
    â”‚   â””â”€â”€ {another-pipeline-run-id}/
    â”œâ”€â”€ agents/                    # Agent working directories
    â”‚   â”œâ”€â”€ content-creator/       # Content Creator Agent workspace
    â”‚   â”‚   â”œâ”€â”€ working/           # Temporary working files
    â”‚   â”‚   â””â”€â”€ cache/             # Agent-specific cache
    â”‚   â”œâ”€â”€ source-manager/        # Source Manager Agent workspace
    â”‚   â”‚   â”œâ”€â”€ working/           # Temporary working files
    â”‚   â”‚   â”œâ”€â”€ gitea-sync/        # Gitea synchronization staging
    â”‚   â”‚   â””â”€â”€ cache/             # Agent-specific cache
    â”‚   â””â”€â”€ shared-tools/          # Shared utilities and scripts
    â”œâ”€â”€ shared/                    # Shared resources across all components
    â”‚   â”œâ”€â”€ templates/             # Cached template repositories
    â”‚   â”‚   â”œâ”€â”€ showroom_template_default/
    â”‚   â”‚   â””â”€â”€ cached-repos/
    â”‚   â”œâ”€â”€ git-cache/             # Git repository cache
    â”‚   â””â”€â”€ coordination/          # Global coordination files
    â”‚       â”œâ”€â”€ active-pipelines.json
    â”‚       â””â”€â”€ resource-locks/
    â””â”€â”€ completed/                 # Archived completed pipelines
        â””â”€â”€ {date}/
            â””â”€â”€ {pipeline-run-id}/ # Archived for reference
  
  cleanup-policy: |
    # Workspace Cleanup Policy
    # - Active pipelines: Keep until pipeline completion + 1 hour
    # - Completed pipelines: Archive for 24 hours, then cleanup
    # - Templates cache: Keep for 7 days
    # - Shared cache: Keep for 3 days
    
    ACTIVE_RETENTION_HOURS=1
    COMPLETED_RETENTION_HOURS=24
    TEMPLATE_CACHE_DAYS=7
    SHARED_CACHE_DAYS=3

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: workspace-cleanup
  namespace: workshop-system
  labels:
    app: workshop-template-system
    component: workspace-management
spec:
  schedule: "0 */6 * * *"  # Every 6 hours
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: workshop-system-sa
          containers:
          - name: workspace-cleanup
            image: registry.access.redhat.com/ubi8/ubi:latest
            command:
            - /bin/bash
            - -c
            - |
              echo "ðŸ§¹ Workspace Cleanup Job (ADR-0007)"
              echo "=================================="
              
              WORKSPACE_ROOT="/workspace/shared-data"
              CURRENT_TIME=$(date +%s)
              
              # Cleanup completed pipelines older than 24 hours
              echo "ðŸ—‚ï¸  Cleaning up completed pipelines..."
              find "$WORKSPACE_ROOT/completed" -type d -name "pipeline-run-*" -mtime +1 -exec rm -rf {} \; 2>/dev/null || true
              
              # Cleanup active pipelines that are stale (older than 6 hours)
              echo "ðŸ”„ Cleaning up stale active pipelines..."
              find "$WORKSPACE_ROOT/active-pipelines" -type d -name "pipeline-run-*" -mtime +0.25 -exec rm -rf {} \; 2>/dev/null || true
              
              # Cleanup old template cache
              echo "ðŸ“¦ Cleaning up template cache..."
              find "$WORKSPACE_ROOT/templates/cached-repos" -type d -mtime +7 -exec rm -rf {} \; 2>/dev/null || true
              
              # Cleanup shared cache
              echo "ðŸ’¾ Cleaning up shared cache..."
              find "$WORKSPACE_ROOT/shared-cache" -type f -mtime +3 -delete 2>/dev/null || true
              
              # Report storage usage
              echo "ðŸ“Š Current workspace usage:"
              du -sh "$WORKSPACE_ROOT"/* 2>/dev/null || echo "No workspace directories found"
              
              echo "âœ… Workspace cleanup completed"
            volumeMounts:
            - name: shared-workspace
              mountPath: /workspace/shared-data
            resources:
              requests:
                memory: "128Mi"
                cpu: "100m"
              limits:
                memory: "256Mi"
                cpu: "200m"
          volumes:
          - name: shared-workspace
            persistentVolumeClaim:
              claimName: shared-workspace-storage
          restartPolicy: OnFailure
